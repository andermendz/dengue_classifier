<!DOCTYPE html>
<html>

<head>
  <title>Dengue Prediction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.socket.io/4.4.1/socket.io.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <script>
    // Iniciar la conexión
    const socket = io();

    $(document).ready(function() {
      $("#predictionForm").submit(function(event) {
        // Prevenir el envío tradicional del formulario, que recargaría la página
        event.preventDefault();

        // Validar el formulario antes de enviarlo
        if (!validateForm()) {
          return;
        }

        // Mostrar mensajes de estado iniciales
        $("#classified-answer").html("Calculando la clasificación del caso...");
        $("#aianswer").html("Contactando al asistente de IA...");

        // Convertir datos del formulario a un objeto simple
        const formData = $(this).serializeArray();
        const data = {};
        $.each(formData, function() {
          data[this.name] = this.value;
        });
        
        // Asegurarse de que los checkboxes no seleccionados se envíen como '0'
        $('#predictionForm input[type=checkbox]').each(function() {
            if (!this.checked) {
                data[this.name] = '0';
            }
        });

        // Enviar datos al servidor a través de Socket.IO
        socket.emit('submit_prediction', data);
      });

      // Escuchar la respuesta de la clasificación local
      socket.on("classified_answer", function(data) {
        const {
          predicted_conducta,
          predicted_clasfinal
        } = data;
        // Mostrar la respuesta clasificada inmediatamente
        $("#classified-answer").html(
          `El caso presentado tendría como clasificación: <strong>${predicted_clasfinal}</strong>, y el tipo de atención más probable sería: <strong>${predicted_conducta}</strong>`
        );
        // Preparar el espacio para la respuesta de la IA, que llegará después
        $("#aianswer").empty();
      });

      // Escuchar la respuesta de la IA en streaming
      let aiResponse = "";
      socket.on("ai_response", function(data) {
        const {
          data: chunk
        } = data;
        aiResponse += chunk;
        const formattedResponse = aiResponse.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
        $("#aianswer").html(formattedResponse);
      });

      // Manejar errores de comunicación o del servidor
      socket.on('error', function(err) {
        $("#aianswer").html(`<p style="color: red;">Error de comunicación con el servidor: ${err.message}</p>`);
      });
    });

    function validateForm() {
        let isValid = true;
        const edad = document.getElementById("edad").value;
        const sexo = document.getElementById("sexo").value;
        const edadError = document.getElementById("edadError");
        const sexoError = document.getElementById("sexoError");

        if (!edad || edad < 1 || edad > 99) {
            edadError.classList.remove("hidden");
            isValid = false;
        } else {
            edadError.classList.add("hidden");
        }
        if (!sexo) {
            sexoError.classList.remove("hidden");
            isValid = false;
        } else {
            sexoError.classList.add("hidden");
        }
        return isValid;
    }
  </script>

</head>

<body>

  <section>
    <div class="px-8 py-24 mx-auto md:px-12 lg:px-32 max-w-7xl">
      <!-- ... El resto de su contenido HTML informativo ... -->
    </div>
  </section>

  <section>
    <div class="flex items-center lg:col-span-2 flex-col text-center">
      <h1 class="text-2xl font-semibold tracking-tighter text-gray-900 lg:text-3xl text-balance">
        Los resultados proporcionados por este algoritmo predictivo sobre la gravedad del dengue son orientativos y no deben sustituir la consulta médica profesional.
      </h1>
      <p class="mt-4 text-base font-medium text-gray-500 text-balance">
        Si tiene alguna preocupación o duda sobre su salud, por favor consulte a un médico
      </p>
    </div>
    <div class="px-8 py-24 mx-auto md:px-12 lg:px-32 max-w-7xl">
      <div class="grid items-center gap-12 lg:grid-cols-2 lg:gap-24">
        <div class="p-2 border bg-gray-50 rounded-3xl">
          <div class="p-10 bg-white border shadow-lg rounded-2xl">
            <!-- *** LA CORRECCIÓN ESTÁ AQUÍ: onsubmit="return false;" HA SIDO ELIMINADO *** -->
            <form id="predictionForm">
              <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2" for="edad">Edad:</label>
                <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" type="number" id="edad" name="edad" min="1" max="99" required />
                <p id="edadError" class="text-red-500 text-xs italic hidden">Por favor, ingrese una edad válida entre 1 y 99.</p>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2" for="sexo">Sexo:</label>
                <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="sexo" name="sexo" required>
                  <option value="M">Masculino</option>
                  <option value="F">Femenino</option>
                </select>
                <p id="sexoError" class="text-red-500 text-xs italic hidden">Por favor, seleccione su sexo.</p>
              </div>
              <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Síntomas:</label>
                <div class="flex items-center mb-2"><input id="fiebre" type="checkbox" name="fiebre" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="fiebre" class="ml-2 text-gray-700">Fiebre</label></div>
                <div class="flex items-center mb-2"><input id="cefalea" type="checkbox" name="cefalea" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="cefalea" class="ml-2 text-gray-700">Dolor de cabeza (<strong>cefalea</strong>)</label></div>
                <div class="flex items-center mb-2"><input id="dolrretroo" type="checkbox" name="dolrretroo" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="dolrretroo" class="ml-2 text-gray-700">Dolor detrás de los ojos (<strong>dolor retroocular</strong>)</label></div>
                <div class="flex items-center mb-2"><input id="malgias" type="checkbox" name="malgias" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="malgias" class="ml-2 text-gray-700">Dolores musculares (<strong>mialgias</strong>)</label></div>
                <div class="flex items-center mb-2"><input id="artralgia" type="checkbox" name="artralgia" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="artralgia" class="ml-2 text-gray-700">Dolor en las articulaciones (<strong>artralgia</strong>)</label></div>
                <div class="flex items-center mb-2"><input id="erupcionr" type="checkbox" name="erupcionr" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="erupcionr" class="ml-2 text-gray-700">Erupción cutánea</label></div>
                <div class="flex items-center mb-2"><input id="dolor_abdo" type="checkbox" name="dolor_abdo" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="dolor_abdo" class="ml-2 text-gray-700">Dolor abdominal</label></div>
                <div class="flex items-center mb-2"><input id="vomito" type="checkbox" name="vomito" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="vomito" class="ml-2 text-gray-700">Vómito</label></div>
                <div class="flex items-center mb-2"><input id="diarrea" type="checkbox" name="diarrea" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="diarrea" class="ml-2 text-gray-700">Diarrea</label></div>
                <div class="flex items-center mb-2"><input id="hipotensio" type="checkbox" name="hipotensio" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="hipotensio" class="ml-2 text-gray-700">Hipotensión (<strong>presión arterial baja</strong>)</label></div>
                <div class="flex items-center mb-2"><input id="hepatomeg" type="checkbox" name="hepatomeg" value="1" class="form-checkbox h-5 w-5 text-gray-600" /><label for="hepatomeg" class="ml-2 text-gray-700">Hepatomegalia (<strong>agrandamiento del hígado</strong>)</label></div>
              </div>
              <div class="space-y-3">
                <div class="col-span-full">
                  <button type="submit" class="inline-flex items-center justify-center w-full h-12 gap-3 px-5 py-3 font-medium duration-200 bg-gray-100 rounded-xl hover:bg-gray-200 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <span>Predecir</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
        <div class="flex flex-col">
          <h1 id="classified-answer" class="text-2xl font-medium tracking-tighter text-gray-900 lg:text-4xl">
            Detecta la gravedad del paciente,
            <span class="text-gray-600">a partir de los sintomas</span>
          </h1>
          <p id="aianswer" class="mt-4 text-base font-medium text-black text-pretty">
            Utilizando Inteligencia Artificial Generativa
          </p>
        </div>
      </div>
    </div>
  </section>

</body>
</html>Z